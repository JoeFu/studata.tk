<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="Student activity analysis" content="behaviour">
    <meta name="author" content="">
    <title>Student-data Data Query</title>
    <!-- Bootstrap Core CSS -->

    <link href="../vendor/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="../../css/jquery.dataTables.min.css" rel="stylesheet">
    <link href="../../css/buttons.dataTables.min.css" rel="stylesheet">
    <!-- MetisMenu CSS -->
    <link href="../vendor/metisMenu/metisMenu.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="../css/simplequery.css" rel="stylesheet">
    <!-- Morris Charts CSS -->
    <link href="../vendor/morrisjs/morris.css" rel="stylesheet">
    <!-- Awesome Fonts -->
    <link href="../vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <!--JQuery CSS -->
    <link rel="stylesheet" href="../../js/jquery-ui.min.css">
    <link rel="stylesheet" href="../../js/jquery-ui.structure.min.css">
    <link rel="stylesheet" href="../../js/jquery-ui.theme.min.css">
    <link rel="stylesheet" href="../../js/jquery-ui-AutoComplete.css">
    <!-- JS -->
    <script type="text/javascript" src="../../js/jquery-3.2.1.js"></script>
    <script type="text/javascript" src="../../js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="../../js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="../../js/buttons.flash.min.js"></script>
    <script type="text/javascript" src="../../js/jszip.min.js"></script>
    <script type="text/javascript" src="../../js/pdfmake.min.js"></script>
    <script type="text/javascript" src="../../js/vfs_fonts.js"></script>
    <script type="text/javascript" src="../../js/buttons.html5.min.js"></script>
    <script type="text/javascript" src="../../js/buttons.print.min.js"></script>
    <script src="../../js/jquery-ui.min.js"></script>
    <script src="../../js/jquery-ui-AutoComplete.js"></script>


    <script src="../../js/bootstrap.min.js"></script>
    <script src="../vendor/metisMenu/metisMenu.min.js"></script>
    <script src="../vendor/raphael/raphael.min.js"></script>
    <script src="../vendor/morrisjs/morris.min.js"></script>
    <script src="../js/studata-newdashboard.js"></script>
</head>

<body>
    <script src="../../js/devicecheck.js"></script>
    <div id="wrapper">
        <!-- Navigation -->
        <nav class="navbar navbar-default navbar-static-top bg-inverse" role="navigation" style="margin-bottom: 0">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="simplequery.html">Data Query</a>
            </div>

            <div class="navbar-default sidebar" role="navigation">
                <div class="sidebar-nav navbar-collapse">
                    <ul class="nav" id="side-menu">
                        <li class="sidebar-search">
                            <form class="input-group custom-search-form" action="../../help.php" method="POST">
                                <input type="search" name="keyword" class="form-control" placeholder="Search...">
                                <span class="input-group-btn" input type="search">
                                    <button class="btn btn-default" input type="submit">
                                        <i class="fa fa-search"></i>
                                    </button>
                                </span>
                            </form>
                        </li>
                        <li class="active">
                            <a href="index.html">
                                <i class="fa fa-dashboard fa-fw"></i> Dashboard</a>
                        </li>
                        <li>
                            <a href="#">
                                <i class="fa fa-bar-chart-o fa-fw"></i> Charts
                                <span class="fa arrow"></span>
                            </a>
                            <ul class="nav nav-second-level">
                                 <li>
                                    <a href="../../dashboard/MoodleCharts.html">Moodle Charts</a>
                                </li>
                                <li>
                                    <a href="../../dashboard/WebSubmissionCharts.html">WebSubmission Charts</a>
                                </li> 
                                <li>
                                    <a href="Moodlecharts.html"> new Moodle Charts</a>
                                </li>
                                <li>
                                    <a href="WebSubmissionCharts.html"> new WebSubmission Charts</a>
                                </li>
                                <!-- <li>
                                    <a href="Moodlecharts.html">Moodle Charts</a>
                                </li>
                                <li>
                                    <a href="WebSubmissionCharts.html">WebSubmission Charts</a>
                                </li> -->
                            </ul>
                            <!-- /.nav-second-level -->
                        </li>
                        <li>
                            <a href="tables.html">
                                <i class="fa fa-table fa-fw"></i> Tables</a>
                        </li>

                        <li>
                            <a href="#">
                                <i class="fa fa-bar-chart-o fa-fw"></i> Simple Query
                                <span class="fa arrow"></span>
                            </a>
                            <ul class="nav nav-second-level">
                                <li>
                                    <a href="simplequery.html"> Data Query</a>
                                </li>
                                <li>
                                    <a href="../../dashboard/CriticalQuestions.html"> Critical Questions</a>
                                </li>
                            </ul>
                        </li>
                        <li>
                            <a href="#">
                                <i class="fa fa-wrench fa-fw"></i>Setings
                                <span class="fa arrow"></span>
                            </a>
                            <ul class="nav nav-second-level">

                                <li>
                                    <a href="https://github.com/JoeFu/mseproject/issues">Bug report</a>
                                </li>
                            </ul>
                            <!-- /.nav-second-level -->
                        </li>
                        <li>
                            <a href="#">
                                <i class="fa fa-files-o fa-fw"></i>Survey
                                <span class="fa arrow"></span>
                            </a>
                            <ul class="nav nav-second-level">
                                <li>
                                    <a href="survey1.html">Survey 1</a>
                                </li>
                                <li>
                                    <a href="survey2.html">Survey 2</a>
                                </li>
                            </ul>
                            <!-- /.nav-second-level -->
                        </li>
                        <li>
                            <a href="#">
                                <i class="fa fa-lightbulb-o fa-fw"></i>About
                                <span class="fa arrow"></span>
                            </a>
                            <ul class="nav nav-second-level">
                                <li>
                                    <a href="../../about.html">About us</a>
                                </li>
                                <li>
                                    <a href="../../privacy.html">Privacy</a>
                                </li>
                                <li>
                                    <a href="../../terms.html">Terms</a>
                                </li>
                            </ul>
                            <!-- /.nav-second-level -->
                        </li>
                        <li>
                            <a href="help.html">
                                <i class="fa fa-question fa-fw"></i> Help</a>
                        </li>
                    </ul>
                </div>
                <!-- /.sidebar-collapse -->
            </div>
            <!-- /.navbar-static-side -->
        </nav>
        <!--Dynamic Load Data -->
        <script type="text/javascript">
            $('#username').load('../backend/APIs.php?option=postName')
        </script>
        <!--Dynamic Load Data -->
        <!-- <script src="../js/simplequery.js"></script> -->

        <div id="page-wrapper">
            <div class="row">
                <div class="col-lg-12">
                    <h1 class="page-header">Data Query</h1>
                </div>
                <!-- /.col-lg-12 -->
            </div>
            <div class="row">
                <div class="col-lg-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            Handy Tools
                        </div>
                        <section class="text-center">


                        </section>
                    </div>
                </div>

            </div>
            <div>
                <table>
                    <tr rowspan="2">
                        <th>Data source</th>
                        <td>
                            <select id="DataSourceSelect" name="DataSourceSelect">
                            </select>
                        </td>
                        <th>Component</th>
                        <td>
                            <select id="ComponentSelect" name="ComponentSelect">
                            </select>
                        </td>
                    </tr>
                    <tr rowspan="2">
                        <th>Event Name</th>
                        <td>
                            <select id="EventNameSelect" name="EventNameSelect">
                            </select>
                        </td>
                        <th>Event Type</th>
                        <td>
                            <select id="EventTypeSelect" name="EventTypeSelect">
                            </select>
                        </td>
                    </tr>
                </table>
                <table id="tableDatePicker">
                    <tr>
                        <th>Start Date</th>
                        <td width="13"></td>
                        <td>
                            <input type="text" id="FromStartDatePicker" />
                        </td>
                        <td>To</td>
                        <td>
                            <input type="text" id="ToStartDatePicker" />
                        </td>
                    </tr>
                    <tr>
                        <th>Due Date</th>
                        <td width="13"></td>
                        <td>
                            <input type="text" id="FromDueDatePicker" />
                        </td>
                        <td>To</td>
                        <td>
                            <input type="text" id="ToDueDatePicker" />
                        </td>
                    </tr>
                </table>
                <table>
                    <tr>
                        <th>User</th>
                        <td width="60"></td>
                        <td>
                            <select id="UserSelect" name="UserSelect">
                            </select>
                        </td>
                        <td width="55"></td>
                        <td>
                            <table style="margin:auto;border:none; width:100%">
                                <tr>
                                    <th>Grade</th>
                                    <td>
                                        <select id="FromGradeSelect" name="FromGradeSelect">
                                        </select>
                                    </td>
                                    <td>To</td>
                                    <td>
                                        <select id="ToGradeSelect" name="ToGradeSelect">
                                        </select>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
                <table>
                    <tr>
                        <th>Assignment</th>
                        <td>
                            <select id="AssignmentSelect" name="AssignmentSelect">
                            </select>
                        </td>
                        <th>Course</th>
                        <td width="20"></td>
                        <td>
                            <select id="CourseSelect" name="CourseSelect">
                            </select>
                        </td>
                    </tr>
                </table>
                <table>
                    <tr>
                        <th>School Year</th>
                        <td>
                            <select id="SchoolYearSelect" name="SchoolYearSelect">
                            </select>
                        </td>
                        <td width="65"></td>
                        <th>Semester</th>
                        <td>
                            <select id="SemesterSelect" name="SemesterSelect">
                            </select>
                        </td>
                        <td>
                            <button id="buttonSearch" type="button" class="btn btn-info">Search</button>
                        </td>
                    </tr>
                </table>
                <table id="parentResultDataTable">
                    <tr>
                        <th>Result:</th>
                    </tr>
                    <tr>
                        <td>
                            <table id="ResultDataTable" class="display" style="margin:auto;border:none; width:100%"></table>
                        </td>
                    </tr>
                </table>
            </div>
            <script type="text/javascript">
                var dataSet;
                var dataSourceTypeId = "1";
                var selectedComponentId;
                var selectedEventName;
                var selectedEventType;
                var selectedFromStartDate;
                var selectedToStartDate;
                var selectedFromDueDate;
                var selectedToDueDate;
                var selectedUser;
                var selectedFromGrade;
                var selectedToGrade;
                var selectedAssignment;
                var selectedCourse;
                var selectedSchoolYear;
                var selectedSemester;

                $(document).ready(function () {
                    $("#parentResultDataTable").hide();
                    showOrHideDatePickers(dataSourceTypeId);
                    addDataSourceTypes();
                    addLowerGrades(0);
                    addHigherGrades(0);
                    initializeData(dataSourceTypeId);

                    $("#buttonSearch").click(function () {
                        $("#parentResultDataTable").show();

                        var selectedComponentId = $("#ComponentSelect option:selected").val();
                        var selectedEventName = $("#EventNameSelect option:selected").text();
                        var selectedEventType = $("#EventTypeSelect option:selected").val();
                        var selectedFromStartDate = $("#FromStartDatePicker").val();
                        var selectedToStartDate = $("#ToStartDatePicker").val();
                        var selectedFromDueDate = $("#FromDueDatePicker").val();
                        var selectedToDueDate = $("#ToDueDatePicker").val();
                        var selectedUser = $("#UserSelect option:selected").text();
                        var selectedFromGrade = $("#FromGradeSelect option:selected").text();
                        var selectedToGrade = $("#ToGradeSelect option:selected").text();
                        var selectedAssignment = $("#AssignmentSelect option:selected").text();
                        var selectedCourse = $("#CourseSelect option:selected").text();
                        var selectedSchoolYear = $("#SchoolYearSelect option:selected").text();
                        var selectedSemester = $("#SemesterSelect option:selected").text();
                        var parameters = selectedComponentId + "|" + selectedEventName + "|" + selectedEventType + "|" + selectedFromStartDate + "|" + selectedToStartDate + "|" + selectedFromDueDate + "|" + selectedToDueDate + "|" + selectedUser + "|" + selectedFromGrade + "|" + selectedToGrade + "|" + selectedAssignment + "|" + selectedCourse + "|" + selectedSchoolYear + "|" + selectedSemester + "|" + dataSourceTypeId;

                        $.ajax({
                            type: "get",
                            dataType: "json",
                            url: "http://studata.tk/slimapp/public/index.php/api/events/search",
                            data: { "parameters": parameters },
                            success: function (result) {
                                loadResult(result);
                            }
                        });
                    });

                    // On change of data source
                    $("#DataSourceSelect").change(function () {
                        dataSourceTypeId = this.value;
                        showOrHideDatePickers(dataSourceTypeId);
                        initializeData(dataSourceTypeId);
                    })

                    $("#FromGradeSelect").change(function () {
                        var currentGrade = this.value;
                        addHigherGrades(currentGrade);
                    });

                    $("#ToGradeSelect").change(function () {
                        var currentGrade = this.value;
                        addLowerGrades(currentGrade);
                    });
                });

                function initializeData(dataSourceType) {
                    getEventNames(dataSourceType);
                    getEventTypes();
                    getComponents();
                    getUsers();
                    getCourses();
                    getSchoolYears();
                    getSemesters();
                    getAssignments();
                    initDatePickers();
                }

                function showOrHideDatePickers(dataSourceType) {
                    switch (dataSourceType) {
                        case "1": // Moodle Forum
                            $("#tableDatePicker").hide();
                            break;
                        case "2": // WebSubmission
                            $("#tableDatePicker").show();
                            break;
                        default:
                            break;
                    }

                }

                function getEventNames(dataSourceType) {
                    $.ajax({
                        type: "get",
                        dataType: "json",
                        url: "http://studata.tk/slimapp/public/index.php/api/eventnames/" + dataSourceType,
                        success: function (data) {
                            $("#EventNameSelect option").remove();
                            var $select = $('#EventNameSelect');
                            $select.append(
                                "<option id='SelectEventName'></option>");
                            $.each(data, function (index, o) {
                                var $option = $("<option/>").attr("value", index).text(o.Name);
                                $select.append($option);
                            });
                        }
                    });
                }

                function getEventTypes() {
                    $.ajax({
                        type: "get",
                        dataType: "json",
                        url: "http://studata.tk/slimapp/public/index.php/api/eventtypes",
                        success: function (data) {
                            $("#EventTypeSelect option").remove();
                            var $select = $('#EventTypeSelect');
                            $("#EventTypeSelect").append(
                                "<option id='SelectEventType'></option>");
                            $.each(data, function (index, o) {
                                var $option = $("<option/>").attr("value", o.Id).text(o.Name);
                                $select.append($option);
                            });
                        }
                    });
                }

                function getComponents() {
                    $.ajax({
                        type: "get",
                        dataType: "json",
                        url: "http://studata.tk/slimapp/public/index.php/api/components",
                        success: function (data) {
                            $("#ComponentSelect option").remove();
                            var $select = $('#ComponentSelect');
                            $("#ComponentSelect").append(
                                "<option id='SelectComponent'></option>");
                            $.each(data, function (index, o) {
                                var $option = $("<option/>").attr("value", o.Id).text(o.Name);
                                $select.append($option);
                            });
                        }
                    });
                }

                function getUsers() {
                    $.ajax({
                        type: "get",
                        dataType: "json",
                        url: "http://studata.tk/slimapp/public/index.php/api/users",
                        success: function (data) {
                            $("#UserSelect option").remove();
                            var $select = $('#UserSelect');
                            $("#UserSelect").append(
                                "<option id='SelectUser'></option>");
                            $.each(data, function (index, o) {
                                var $option = $("<option/>").attr("value", index).text(o.Id);
                                $select.append($option);
                            });
                        }
                    });
                }

                function getCourses() {
                    $.ajax({
                        type: "get",
                        dataType: "json",
                        url: "http://studata.tk/slimapp/public/index.php/api/courses",
                        success: function (data) {
                            $("#CourseSelect option").remove();
                            var $select = $('#CourseSelect');
                            $("#CourseSelect").append(
                                "<option id='SelectCourse'></option>");
                            $.each(data, function (index, o) {
                                var $option = $("<option/>").attr("value", index).text(o.CourseName);
                                $select.append($option);
                            });
                        }
                    });
                }

                function getSchoolYears() {
                    $.ajax({
                        type: "get",
                        dataType: "json",
                        url: "http://studata.tk/slimapp/public/index.php/api/schoolyears",
                        success: function (data) {
                            $("#SchoolYearSelect option").remove();
                            var $select = $('#SchoolYearSelect');
                            $("#SchoolYearSelect").append(
                                "<option id='SelectSchoolYear'></option>");
                            $.each(data, function (index, o) {
                                var $option = $("<option/>").attr("value", index).text(o.SchoolYear);
                                $select.append($option);
                            });
                        }
                    });
                }

                function getSemesters() {
                    $.ajax({
                        type: "get",
                        dataType: "json",
                        url: "http://studata.tk/slimapp/public/index.php/api/semesters",
                        success: function (data) {
                            $("#SemesterSelect option").remove();
                            var $select = $('#SemesterSelect');
                            $select.append(
                                "<option id='SelectSemester'></option>");
                            $.each(data, function (index, o) {
                                var $option = $("<option/>").attr("value", index).text(o.Semester);
                                $select.append($option);
                            });
                        }
                    });
                }

                function getAssignments() {
                    $.ajax({
                        type: "get",
                        dataType: "json",
                        url: "http://studata.tk/slimapp/public/index.php/api/assignments",
                        success: function (data) {
                            $("#AssignmentSelect option").remove();
                            var $select = $('#AssignmentSelect');
                            $select.append(
                                "<option id='SelectAssignment'></option>");
                            $.each(data, function (index, o) {
                                var $option = $("<option/>").attr("value", index).text(o.AssignmentName);
                                $select.append($option);
                            });
                        }
                    });

                }

                function addHigherGrades(currentGrade) {
                    var selected = $('#ToGradeSelect').val();
                    $('#ToGradeSelect option').remove();

                    $("#ToGradeSelect").append(
                        "<option id='ToGradeSelect'></option>");
                    var grades = [50, 64, 74, 89];
                    // if the value is zero, add the whole array
                    if (currentGrade == 0) {
                        for (var i = 0; i < grades.length; i++) {
                            $("#ToGradeSelect").append(
                                "<option id='ToGradeSelect'>" + grades[i] + "</option>");
                        }
                        return;
                    }

                    // Find the position of currentGrade
                    var pos = -1;
                    for (var i = 0; i < grades.length; i++) {
                        if (grades[i] == currentGrade) {
                            pos = i;
                            break;
                        }
                    }

                    // Bind values for ToGradeSelect
                    for (var i = pos; i < grades.length; i++) {
                        $("#ToGradeSelect").append(
                            "<option id='ToGradeSelect'>" + grades[i] + "</option>");
                    }

                    var options = $("#ToGradeSelect option");
                    sortGradeSelect(options, "#ToGradeSelect");
                    $("#ToGradeSelect").val(selected);
                }

                function sortGradeSelect(options, gradeSelectId) {
                    $(gradeSelectId).html($(gradeSelectId + ' option').sort(function (x, y) {
                        return $(x).text() < $(y).text() ? -1 : 1;
                    }));
                    //$(gradeSelectId).get(0).selectedIndex = 0;
                }

                function addLowerGrades(currentGrade) {
                    var selected = $("#FromGradeSelect").val();
                    $('#FromGradeSelect option').remove();
                    $("#FromGradeSelect").append(
                        "<option id='FromGradeSelect'></option>");

                    var grades = [50, 64, 74, 89];
                    // if the value is zero, add the whole array
                    if (currentGrade == 0) {
                        for (var i = 0; i < grades.length; i++) {
                            $("#FromGradeSelect").append(
                                "<option id='FromGradeSelect'>" + grades[i] + "</option>");
                        }
                        return;
                    }

                    // Find the position of currentGrade
                    var pos = -1;
                    for (var i = 0; i < grades.length; i++) {
                        if (grades[i] == currentGrade) {
                            pos = i;
                            break;
                        }
                    }

                    // Bind values for ToGradeSelect
                    for (var i = pos; i >= 0; i--) {
                        $("#FromGradeSelect").append(
                            "<option id='FromGradeSelect'>" + grades[i] + "</option>");
                    }

                    var options = $("#FromGradeSelect option");
                    sortGradeSelect(options, "#FromGradeSelect");
                    $("#FromGradeSelect").val(selected);
                }

                function addDataSourceTypes() {
                    var $select = $('#DataSourceSelect');
                    var $option = $("<option/>").attr("value", 1).text("Moodle Forum");
                    $select.append($option);
                    $option = $("<option/>").attr("value", 2).text("WebSubmission");
                    $select.append($option);
                }

                function initDatePickers() {
                    $("#FromStartDatePicker").datepicker({ dateFormat: "yy/mm/dd" });
                    $("#ToStartDatePicker").datepicker({ dateFormat: "yy/mm/dd" });
                    $("#FromDueDatePicker").datepicker({ dateFormat: "yy/mm/dd" });
                    $("#ToDueDatePicker").datepicker({ dateFormat: "yy/mm/dd" });
                }

                function loadResult(data) {
                    var dataTable = $('#ResultDataTable').DataTable({
                        destroy: true,
                        data: data,
                        columns: [
                            { title: "Assignment", data: "AssignmentName" },
                            { title: "Course", data: "CourseName" },
                            { title: "Description", data: "Description" },
                            { title: "Due date", data: "DueDate", visible: false },
                            { title: "User", data: "FKUserId" },
                            { title: "Grade", data: "Grade" },
                            { title: "Name", data: "Name" },
                            { title: "School Year", data: "SchoolYear" },
                            { title: "Semester", data: "Semester" },
                            { title: "Start date", data: "StartDate", visible: false }
                        ],
                        dom: 'Bfrtip',
                        buttons: [
                            'copy', 'csv', 'excel', 'pdf', 'print'
                        ]
                    });

                    var startDateColumn = table.column($(this).attr('StartDate'));
                    var dueDateColumn = table.column($(this).attr('DueDate'));
                    switch (dataSourceType) {
                        case "1":
                            startDateColumn.visible(false);
                            dueDateColumn.visible(false);
                            break;
                        case "2":
                            startDateColumn.visible(true);
                            dueDateColumn.visible(true);
                            break;
                        default:
                            startDateColumn.visible(false);
                            dueDateColumn.visible(false);
                            break;
                    }
                }
            </script>

            <!-- /.row -->
            <div class="row">
            </div>

            <div class="row">
                <div class="col-lg-12">
                    <br>
                    <br>
                    <br>
                    <br>
                    <br>
                    <br>
                    <p class="text-right">
                        <a href="#" title="Back to Top">
                            <i class="fa fa-arrow-up fa-3x" aria-hidden="true"></i>
                        </a>
                    </p>
                </div>
                <!-- /.row -->
            </div>
            <!-- /#page-wrapper -->
            <!--divider-->
            <hr class="featurette-divider">
            <!-- End features -->
            <!-- FOOTER -->
            <footer>
                <p class="text-center">&copy; 2017 Student_data Project Team. &brvbar;
                    <a href="../../privacy.html">Privacy</a> &middot;
                    <a href="../../terms.html">Terms</a>
                </p>
            </footer>
        </div>
        <!-- /#wrapper -->

</body>

</html>